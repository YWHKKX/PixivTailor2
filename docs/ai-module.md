# AI模块文档

AI模块是PixivTailor的核心功能模块，负责所有与人工智能相关的操作，包括图像生成、模型训练、图像标签和标签分类。

## 📁 模块结构

- **backend/internal/ai/**: AI模块核心实现目录
- **ai.go**: AI模块核心实现文件

## 🔧 核心组件

### 1. Generator - AI图像生成器

**功能描述**: 负责使用Stable Diffusion WebUI生成AI图像

**主要功能**:
- **GenerateImages**: 生成AI图像
- **SaveImage**: 保存生成的图像
- **GetModels**: 获取可用模型列表
- **GetLoras**: 获取可用LoRA模型列表

**支持功能**:
- Stable Diffusion WebUI API集成
- 多LoRA模型组合使用
- ControlNet姿态控制
- 批量图像生成
- 自定义参数配置
- 模型和LoRA管理

### 2. Trainer - 模型训练器

**功能描述**: 负责使用Kohya-ss训练LoRA模型

**主要功能**:
- **TrainModel**: 训练LoRA模型
- **GetTrainingStatus**: 获取训练状态
- **StopTraining**: 停止训练任务
- **GetPretrainedModels**: 获取预训练模型列表

**支持功能**:
- Kohya-ss训练框架集成
- LoRA模型训练
- 多标签联合训练
- 训练参数优化
- 训练进度监控
- 训练任务管理

**训练参数**:
- **模型名称**: 自定义LoRA模型名称
- **预训练模型**: 基础模型路径
- **训练数据**: 输入图像目录
- **训练轮数**: 训练epoch数量
- **批次大小**: 训练批次大小
- **学习率**: 训练学习率
- **标签配置**: 训练标签设置

### 3. Tagger - 图像标签器

**功能描述**: 负责为图像自动生成标签

**主要功能**:
- **GenerateTags**: 生成图像标签
- **SaveTags**: 保存标签到文件
- **GetAvailableAnalyzers**: 获取可用的分析器
- **AnalyzeImage**: 分析单张图像

**支持功能**:
- WD14Tagger自动标签生成
- DeepDanbooru标签支持
- 标签分类和过滤
- 批量图像处理
- 标签置信度设置
- 多种输出格式

### 4. Classifier - 标签分类器

**功能描述**: 负责对标签进行智能分类

**主要功能**:
- **ClassifyTags**: 分类标签集合
- **SaveClassification**: 保存分类结果
- **GetCategories**: 获取标签分类
- **ClassifySingleTag**: 分类单个标签

**支持功能**:
- OpenAI API集成
- 智能标签分类
- 全局标签管理
- 多API密钥支持
- 分类规则配置

## 🚀 主要功能

### 1. AI图像生成

**功能描述**: 使用Stable Diffusion生成高质量AI图像

**支持特性**:
- **多模型支持**: 支持多种Stable Diffusion模型
- **LoRA集成**: 支持LoRA模型的组合使用
- **参数调优**: 支持CFG Scale、采样步数等参数调整
- **批量生成**: 支持一次生成多张图像
- **质量控制**: 支持正面和负面提示词
- **尺寸设置**: 支持自定义图像尺寸

### 2. LoRA模型训练

**功能描述**: 训练自定义LoRA模型

**训练流程**:
- **数据准备**: 准备训练图像和标签数据
- **参数配置**: 设置训练参数和超参数
- **训练执行**: 启动训练任务并监控进度
- **模型保存**: 保存训练完成的模型
- **质量评估**: 评估模型训练效果

### 3. 图像标签生成

**功能描述**: 自动为图像生成标签

**处理流程**:
- **图像分析**: 使用AI模型分析图像内容
- **标签提取**: 提取图像中的特征标签
- **置信度评估**: 计算标签的置信度分数
- **标签过滤**: 过滤低质量或重复标签
- **结果保存**: 保存标签到指定格式文件

### 4. 标签智能分类

**功能描述**: 对标签进行智能分类和整理

**分类流程**:
- **标签收集**: 收集所有需要分类的标签
- **AI分析**: 使用AI模型分析标签含义
- **分类规则**: 根据预设规则进行分类
- **结果整理**: 整理分类结果并保存
- **质量控制**: 验证分类结果的准确性

## ⚙️ 配置参数

### Stable Diffusion配置
- **API地址**: WebUI服务地址
- **超时时间**: 请求超时设置
- **重试次数**: 失败重试次数
- **默认模型**: 默认使用的模型
- **默认采样器**: 默认采样算法
- **默认参数**: CFG Scale、步数等默认值

### Kohya-ss配置
- **API地址**: 训练服务地址
- **超时时间**: 训练超时设置
- **默认参数**: 默认训练参数
- **资源限制**: 内存和GPU使用限制

### OpenAI配置
- **API密钥**: OpenAI API密钥列表
- **模型选择**: 使用的GPT模型
- **参数设置**: 温度、最大令牌数等
- **速率限制**: API调用频率限制

### WD14Tagger配置
- **模型路径**: 标签模型文件路径
- **阈值设置**: 标签置信度阈值
- **批次大小**: 处理批次大小
- **跳过标签**: 需要跳过的标签列表
- **扩展标签**: 需要扩展的标签列表

## 🔄 工作流程

### 1. 图像生成流程
- 接收生成请求参数
- 验证参数有效性
- 构建API请求
- 调用Stable Diffusion WebUI
- 处理生成结果
- 保存生成的图像
- 返回结果信息

### 2. 模型训练流程
- 验证训练数据
- 配置训练参数
- 启动训练任务
- 监控训练进度
- 处理训练异常
- 保存训练结果
- 生成训练报告

### 3. 标签生成流程
- 扫描图像目录
- 加载标签模型
- 批量分析图像
- 提取图像标签
- 计算置信度
- 过滤和整理标签
- 保存标签文件

### 4. 标签分类流程
- 收集标签数据
- 构建分类请求
- 调用AI分类服务
- 处理分类结果
- 验证分类准确性
- 保存分类文件

## 🛡️ 错误处理

### 常见错误类型
- **API连接失败**: 无法连接到AI服务
- **参数验证错误**: 输入参数格式错误
- **资源不足**: 内存或GPU资源不足
- **模型加载失败**: AI模型加载错误
- **训练中断**: 训练过程异常中断

### 错误处理策略
- **自动重试**: 网络错误自动重试
- **参数验证**: 严格的参数验证机制
- **资源监控**: 实时监控系统资源
- **异常恢复**: 训练中断自动恢复
- **详细日志**: 记录详细错误信息

## 📈 性能优化

### 1. 资源管理
- **内存优化**: 优化内存使用和垃圾回收
- **GPU利用**: 最大化GPU使用效率
- **并发控制**: 合理控制并发任务数量
- **缓存机制**: 缓存常用模型和数据

### 2. 处理优化
- **批量处理**: 批量处理图像和标签
- **异步操作**: 异步执行耗时任务
- **进度监控**: 实时监控处理进度
- **结果缓存**: 缓存处理结果避免重复计算

## 🔒 安全与合规

### 1. 数据安全
- **隐私保护**: 保护用户数据和隐私
- **安全传输**: 使用HTTPS安全传输
- **访问控制**: 限制API访问权限
- **数据加密**: 敏感数据加密存储

### 2. 使用规范
- **合规使用**: 遵守AI服务使用条款
- **内容审核**: 对生成内容进行审核
- **版权保护**: 尊重原创内容版权
- **道德约束**: 遵循AI使用道德准则