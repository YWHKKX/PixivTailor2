# AI模块文档

AI模块是PixivTailor的核心功能模块，负责所有与人工智能相关的操作，包括图像生成、模型训练、图像标签和标签分类。

## 📁 模块结构

### AI生成功能
- **backend/internal/http/ai_handler.go**: AI处理器实现 ✅
- **backend/internal/http/generation_config_handler.go**: 生成配置处理器 ✅
- **backend/internal/service/generation_config_service.go**: 生成配置服务 ✅
- **backend/internal/repository/generation_config.go**: 生成配置存储 ✅
- **backend/pkg/models/generation_config.go**: 生成配置模型 ✅
- **frontend/src/pages/AIGeneratorPage.tsx**: AI生成器页面 ✅
- **frontend/src/services/aiService.ts**: AI服务客户端 ✅

### 图像标签功能
- **backend/internal/http/tagger_handler.go**: 标签处理器实现 ✅
- **backend/internal/http/server.go**: HTTP服务器集成 ✅
- **backend/pkg/models/models.go**: 标签数据模型 ✅
- **frontend/src/pages/TaggerPage.tsx**: 标签生成器页面 ✅
- **frontend/src/services/api.ts**: API服务客户端（包含标签API）✅

## 🔧 核心组件

### 1. AIHandler - AI图像生成处理器 ✅

**功能描述**: 负责使用Stable Diffusion WebUI生成AI图像

**主要功能**:
- **HandleGenerateWithConfig**: 使用配置生成AI图像 ✅
- **ExecuteGenerateTask**: 实现 TaskExecutor 接口，执行AI生成任务 ✅
- **forwardToWebUI**: 转发请求到WebUI API ✅
- **downloadAndSaveImages**: 下载并保存生成的图像 ✅
- **stopWebUIGeneration**: 停止WebUI生成任务 ✅

**支持功能**:
- Stable Diffusion WebUI API集成 ✅
- 多LoRA模型组合使用 ✅
- 批量图像生成 ✅
- 自定义参数配置 ✅
- 任务管理和监控（基于 TaskService）✅
- 类型级别并发控制（execute 类型任务串行）✅
- 循环发包支持 ✅
- 执行器模式注册 ✅

### 2. GenerationConfigService - 生成配置服务 ✅

**功能描述**: 负责管理AI生成配置

**主要功能**:
- **CreateConfig**: 创建生成配置 ✅
- **UpdateConfig**: 更新生成配置 ✅
- **DeleteConfig**: 删除生成配置 ✅
- **GetConfig**: 获取单个配置 ✅
- **ListConfigs**: 获取配置列表 ✅
- **GetConfigsByCategory**: 按分类获取配置 ✅

**支持功能**:
- 文件系统配置管理 ✅
- 配置分类管理 ✅
- LoRA模型配置 ✅
- 参数模板管理 ✅
- 配置验证 ✅

### 3. AIGeneratorPage - AI生成器前端页面 ✅

**功能描述**: 提供AI图像生成的Web界面

**主要功能**:
- **配置管理**: 加载和应用生成配置 ✅
- **参数调整**: 实时调整生成参数 ✅
- **任务管理**: 监控和管理生成任务 ✅
- **图片查看**: 查看和下载生成的图片 ✅
- **批量操作**: 批量删除任务 ✅
- **实时更新**: WebSocket实时状态更新 ✅

**支持功能**:
- 响应式界面设计 ✅
- 实时进度显示 ✅
- 图片查看器（支持大图缩放、键盘导航）✅
- 键盘导航支持（方向键、ESC键）✅
- 任务详情查看 ✅
- 错误处理 ✅
- 本地缓存（刷新后保持配置）✅
- WebUI状态监控 ✅
- 角色配置选择和应用 ✅

### 4. TaggerHandler - 图像标签处理器 ✅

**功能描述**: 负责图像标签生成和管理

**主要功能**:
- **CreateTagTask**: 创建标签生成任务 ✅
- **GetTaggedImages**: 获取已标签的图像 ✅
- **GetAvailableAnalyzers**: 获取可用的分析器 ✅
- **AnalyzeImage**: 分析单张图像 ✅
- **GetTagTaskStatus**: 获取标签任务状态 ✅
- **StopTagTask**: 停止标签任务 ✅

**支持功能**:
- 多种标签分析器支持（WD14Tagger、DeepDanbooru）✅
- 批量图像处理 ✅
- 标签置信度评分 ✅
- 多种保存格式（TXT、JSON、CSV）✅
- 任务管理和监控 ✅

### 5. TaggerPage - 标签生成器前端页面 ✅

**功能描述**: 提供图像标签生成的Web界面

**主要功能**:
- **配置管理**: 设置输入目录、分析器、输出格式等 ✅
- **任务管理**: 创建、监控、停止标签生成任务 ✅
- **结果展示**: 查看生成的标签和置信度 ✅
- **文件树集成**: 与现有文件系统集成 ✅
- **实时更新**: WebSocket实时状态更新 ✅

**支持功能**:
- 响应式界面设计 ✅
- 实时进度显示 ✅
- 标签可视化展示 ✅
- 任务详情查看 ✅
- 错误处理 ✅

### 6. 规划功能 (待实现)

**模型训练器**:
- Kohya-ss训练框架集成
- LoRA模型训练
- 训练进度监控

**标签分类器**:
- OpenAI API集成
- 智能标签分类
- 全局标签管理

## 🚀 主要功能

### 1. AI图像生成 ✅

**功能描述**: 使用Stable Diffusion生成高质量AI图像

**支持特性**:
- **多模型支持**: 支持多种Stable Diffusion模型 ✅
- **LoRA集成**: 支持LoRA模型的组合使用 ✅
- **参数调优**: 支持CFG Scale、采样步数等参数调整 ✅
- **批量生成**: 支持一次生成多张图像 ✅
- **质量控制**: 支持正面和负面提示词 ✅
- **尺寸设置**: 支持自定义图像尺寸 ✅
- **循环发包**: 支持多次发包生成 ✅
- **并发控制**: 防止重复生成任务 ✅
- **实时监控**: WebSocket实时状态更新 ✅

### 2. 配置管理系统 ✅

**功能描述**: 管理AI生成配置和参数模板

**支持功能**:
- **文件系统配置**: 基于JSON文件的配置管理（data/configs/）✅
- **配置分类**: 按分类组织配置 ✅
- **LoRA配置**: LoRA模型路径和权重配置 ✅
- **参数模板**: 预设参数模板 ✅
- **配置验证**: 配置参数验证 ✅
- **配置应用**: 一键应用配置到生成参数 ✅
- **本地缓存**: localStorage缓存配置参数 ✅
- **角色配置**: 从标签文件提取角色特征 ✅

**角色特征管理**:
- 从标签JSON文件中提取标签统计
- 分析标签频率和权重
- 创建角色特征配置文件
- 支持核心标签、包含标签、排除标签筛选
- 自动提取高频高权重标签作为特征

### 3. 任务管理系统 ✅

**功能描述**: 管理AI生成任务的完整生命周期，基于统一的任务管理器（详见[任务管理器文档](./task-manager.md)）

**支持功能**:
- **任务创建**: 创建AI生成任务 ✅
- **任务监控**: 实时监控任务状态和进度 ✅
- **任务控制**: 启动、停止、取消任务 ✅
- **任务历史**: 查看任务历史和结果 ✅
- **批量操作**: 批量删除任务 ✅
- **错误处理**: 详细的错误信息和重试机制 ✅
- **并发控制**: 同类型任务串行，不同类型任务可并发 ✅
- **队列管理**: 按类型分组的智能等待队列 ✅

**任务执行流程**:
```
1. Handler 接收请求 → 创建任务（taskService.CreateTask）
2. TaskService 检查队列 → 同类型任务串行，不同类型可并发
3. 调用执行器 → AIHandler.ExecuteGenerateTask
4. 执行实际逻辑 → WebUI调用、图片下载
5. 任务完成 → 自动触发下一个任务
```

**API集成**:
- `POST /api/tasks` - 获取任务列表
- `POST /api/status` - 获取任务状态
- `POST /api/task/start` - 启动任务
- `POST /api/task/stop` - 停止任务
- `POST /api/cancel` - 取消任务

### 4. 图片管理系统 ✅

**功能描述**: 管理生成的图片文件

**支持功能**:
- **自动下载**: 自动下载WebUI生成的图片 ✅
- **格式检测**: 自动检测图片格式(PNG/JPG/WebP) ✅
- **文件命名**: 按任务ID和序号命名文件（格式: generated_{taskID}_{index}.png）✅
- **图片查看**: 内置图片查看器 ✅
- **图片下载**: 支持单张和批量下载 ✅
- **键盘导航**: 支持方向键（←/→）切换、ESC关闭 ✅
- **大图缩放**: 自动按比例缩放，完整显示在容器内 ✅
- **任务隔离**: 每个任务的图片独立存储 ✅

### 5. 图像标签生成 ✅

**功能描述**: 使用AI模型自动为图像生成标签

**支持功能**:
- **自动标签**: WD14Tagger自动标签生成 ✅
- **批量处理**: 批量图像标签处理 ✅
- **多分析器**: 支持WD14Tagger、DeepDanbooru等 ✅
- **标签管理**: 标签过滤、扩展、排序 ✅
- **多格式**: 支持TXT、JSON、CSV格式保存 ✅
- **置信度**: 标签置信度评分 ✅
- **任务监控**: 实时任务状态监控 ✅

### 6. 角色特征管理系统 ✅

**功能描述**: 从标签文件中提取和分析角色特征，生成角色配置

**支持功能**:
- **标签提取**: 从多个标签JSON文件中提取标签统计 ✅
- **频率分析**: 统计标签出现频率 ✅
- **权重分析**: 分析标签的平均权重 ✅
- **特征筛选**: 支持最小频率、最小权重阈值筛选 ✅
- **核心标签**: 定义核心关键词（如character_name）✅
- **包含/排除**: 手动指定必须包含或排除的标签 ✅
- **最大标签数**: 限制提取的标签数量 ✅
- **配置保存**: 保存角色特征到JSON文件（data/characters/）✅

**角色配置结构**:
```json
{
  "id": 1738068022,
  "name": "艾尔莎",
  "description": "角色描述",
  "tags": ["1girl", "character_name", ...],
  "tag_weights": {
    "1girl": 0.95,
    "character_name": 0.99,
    ...
  },
  "created_at": "2025-10-28T10:00:00Z",
  "updated_at": "2025-10-28T10:00:00Z"
}
```

**使用流程**:
1. 选择包含角色标签的来源目录
2. 设置筛选条件（频率、权重、最大标签数）
3. 指定核心关键词（如character_name）
4. 定义包含/排除标签
5. 提取并生成角色配置文件
6. 在AI生成时选择和启用角色配置

## ⚙️ 配置参数

### Stable Diffusion配置 ✅
- **API地址**: WebUI服务地址 (默认: http://127.0.0.1:7860)
- **超时时间**: 请求超时设置 (默认: 无限制)
- **重试次数**: 失败重试次数
- **默认模型**: 默认使用的模型
- **默认采样器**: 默认采样算法
- **默认参数**: CFG Scale、步数等默认值

### 生成参数配置 ✅
- **提示词**: 正面提示词 (支持多行输入)
- **负面提示词**: 负面提示词 (支持多行输入)
- **采样步数**: 采样步数 (默认: 20)
- **CFG Scale**: CFG缩放因子 (默认: 7)
- **图像尺寸**: 生成图像尺寸 (默认: 512x512)
- **批次数量**: 每批生成数量 (默认: 1)
- **循环数量**: 发包次数 (默认: 1)
- **启用Hires**: 是否启用高分辨率修复
- **Hires步数**: 高分辨率修复步数
- **Hires缩放**: 高分辨率缩放因子
- **Hires采样器**: 高分辨率采样器

### LoRA配置 ✅
- **LoRA模型**: LoRA模型路径列表
- **LoRA权重**: 每个LoRA的权重值
- **LoRA启用**: 是否启用LoRA模型
- **LoRA组合**: 支持多个LoRA同时使用

### 任务管理配置 ✅
- **并发控制**: 防止重复生成任务
- **任务超时**: 任务执行超时时间
- **重试机制**: 失败任务重试策略
- **日志级别**: 日志记录级别

## 🔄 工作流程

### 1. AI图像生成流程 ✅
1. **接收请求**: 接收前端生成请求参数
2. **参数验证**: 验证参数有效性和完整性
3. **配置加载**: 加载指定的生成配置
4. **参数合并**: 合并配置参数和覆盖参数
5. **任务创建**: 调用 taskService.CreateTask("generate", config)
6. **队列调度**: TaskService 检查同类型运行任务
   - 有运行中 → 加入等待队列
   - 无运行中 → 立即启动
7. **执行器调用**: TaskService 调用 AIHandler.ExecuteGenerateTask
8. **WebUI调用**: 转发请求到Stable Diffusion WebUI
9. **图片下载**: 下载生成的图片到本地
10. **任务更新**: 更新任务状态和结果
11. **触发下一个**: 任务完成后自动启动等待队列中的下一个任务
12. **WebSocket通知**: 通过WebSocket通知前端更新

### 2. 配置管理流程 ✅
1. **配置加载**: 从文件系统加载配置
2. **配置验证**: 验证配置格式和参数
3. **分类管理**: 按分类组织配置
4. **配置应用**: 应用配置到生成参数
5. **参数覆盖**: 支持参数覆盖和自定义
6. **配置保存**: 保存配置到文件系统

### 3. 任务管理流程 ✅
1. **任务创建**: 创建新的生成任务
2. **状态跟踪**: 跟踪任务状态变化
3. **进度更新**: 实时更新任务进度
4. **错误处理**: 处理任务执行错误
5. **任务完成**: 标记任务完成状态
6. **结果保存**: 保存任务结果和图片

### 4. 图片管理流程 ✅
1. **图片接收**: 接收WebUI生成的图片
2. **格式检测**: 检测图片格式(PNG/JPG/WebP)
3. **文件保存**: 保存图片到任务目录
4. **URL生成**: 生成图片访问URL
5. **图片查看**: 提供图片查看功能
6. **图片下载**: 支持图片下载功能

## 🛡️ 错误处理

### 常见错误类型 ✅
- **API连接失败**: 无法连接到Stable Diffusion WebUI
- **参数验证错误**: 输入参数格式错误
- **配置加载失败**: 配置文件不存在或格式错误
- **任务并发冲突**: 同时运行多个生成任务
- **图片下载失败**: 生成的图片下载失败
- **WebUI响应错误**: WebUI返回错误响应

### 错误处理策略 ✅
- **自动重试**: 网络错误自动重试
- **参数验证**: 严格的参数验证机制
- **并发控制**: 防止重复任务执行
- **详细日志**: 记录详细错误信息
- **用户提示**: 友好的错误提示信息
- **任务恢复**: 失败任务状态管理

## 📈 性能优化

### 1. 资源管理 ✅
- **并发控制**: 限制同时运行的生成任务数量
- **内存优化**: 优化图片处理和内存使用
- **文件管理**: 按任务ID组织文件结构
- **缓存机制**: 缓存配置和常用数据

### 2. 处理优化 ✅
- **异步处理**: 异步执行生成任务
- **进度监控**: 实时监控任务进度
- **批量操作**: 支持批量任务操作
- **WebSocket通信**: 实时状态更新

## 🔒 安全与合规

### 1. 数据安全 ✅
- **文件隔离**: 按任务ID隔离文件存储
- **访问控制**: 限制文件访问权限
- **数据验证**: 验证输入参数和配置
- **错误处理**: 安全的错误处理机制

### 2. 使用规范 ✅
- **合规使用**: 遵守AI服务使用条款
- **内容审核**: 对生成内容进行审核
- **版权保护**: 尊重原创内容版权
- **道德约束**: 遵循AI使用道德准则

## 📊 API接口

### HTTP API ✅
- **POST /api/generate-with-config**: 使用配置生成AI图像
- **GET /api/configs**: 获取配置列表
- **GET /api/configs/{id}**: 获取单个配置
- **POST /api/configs**: 创建配置
- **PUT /api/configs/{id}**: 更新配置
- **DELETE /api/configs/{id}**: 删除配置
- **GET /api/tasks/{taskId}/images/{index}**: 获取生成的图片

### WebSocket API ✅
- **task_update**: 任务状态更新
- **progress_update**: 任务进度更新
- **log_message**: 任务日志消息
- **webui_status**: WebUI状态更新

## 🎯 使用示例

### 1. 基本使用
```bash
# 启动系统
./start-dev.bat

# 访问AI生成器页面
http://localhost:3000
```

### 2. 配置管理
```json
{
  "name": "动漫风格配置",
  "category": "动漫",
  "description": "生成动漫风格图像",
  "model": "anime_model.safetensors",
  "lora": [
    {
      "path": "anime_lora.safetensors",
      "weight": 0.8
    }
  ],
  "params": {
    "steps": 20,
    "cfg_scale": 7,
    "width": 512,
    "height": 512
  }
}
```

### 3. 生成参数
```json
{
  "config_id": "anime-style-config",
  "prompt": "1girl, anime style, beautiful",
  "negative_prompt": "bad quality, blurry",
  "steps": 20,
  "cfg_scale": 7,
  "batch_count": 1,
  "loop_count": 1,
  "width": 512,
  "height": 512
}
```

## 🔗 相关文档

- [任务管理器文档](./task-manager.md) - 统一的任务调度系统
- [配置模块文档](./config-module.md) - 生成配置管理
- [爬虫模块文档](./crawler-module.md) - Pixiv爬虫功能
- [标签模块文档](./tagger-module.md) - 图像标签生成