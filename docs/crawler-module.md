# 爬虫模块文档

爬虫模块是PixivTailor的数据获取模块，负责从Pixiv网站爬取插画数据，支持多种爬取方式和智能限流机制。该模块已完全实现并集成到Web界面中。

## 📁 模块结构

- **backend/internal/crawler/**: 爬虫核心实现目录
- **backend/internal/http/crawler_handler.go**: 爬虫任务处理器 ✅
- **backend/internal/service/task_service.go**: 统一任务调度器 ✅
- **backend/internal/api/**: API接口实现
- **backend/internal/http/**: HTTP服务器集成

## 🔧 核心组件

### Crawler接口

**功能描述**: 定义爬虫的核心功能接口

**主要功能**:
- **CrawlByTag**: 按标签爬取插画数据
- **CrawlByUser**: 按用户ID爬取用户作品
- **CrawlByIllust**: 按插画ID爬取特定作品
- **DownloadImage**: 下载图像文件到本地
- **SetLogCallback**: 设置日志回调函数
- **SetProxy**: 设置代理服务器
- **SetCookie**: 设置Pixiv Cookie
- **SetTaskID**: 设置任务ID用于缓存管理

## 🚀 主要功能

### 1. 标签搜索爬取 ✅

**功能描述**: 根据指定标签搜索并爬取Pixiv插画

**支持参数**:
- **query**: 搜索标签关键词
- **order**: 排序方式（按时间或热度）
- **mode**: 内容模式（安全模式、R18模式、全模式）
- **limit**: 爬取数量限制

**功能特点**:
- 支持多种排序方式（按时间、热度排序）
- 支持内容过滤（安全、R18、全模式）
- 自动获取插画详细信息
- 支持多页结果爬取
- **多图片支持**: 自动下载同一插画的所有页面图片
- **智能缓存系统**: 按日期缓存爬取结果，避免重复API请求
- **Web界面集成**: 通过Web界面进行可视化操作

**支持标签类型**:
- **角色标签**: 人物数量、性别、年龄等
- **风格标签**: 动漫、漫画、写实等风格
- **动作标签**: 坐姿、站姿、躺姿等动作
- **服装标签**: 服装类型、配饰等

### 2. 用户作品爬取 ✅

**功能描述**: 爬取指定用户的所有作品

**支持参数**:
- **userID**: 用户ID
- **limit**: 爬取数量限制

**功能特点**:
- 自动获取用户所有公开作品
- 支持按时间排序
- 过滤私密作品
- 获取作品详细信息和标签
- 支持批量下载
- **多图片支持**: 自动下载同一插画的所有页面图片
- **智能缓存系统**: 按用户ID和日期缓存爬取结果
- **Web界面集成**: 通过Web界面进行可视化操作

### 3. 单图下载 ✅

**功能描述**: 下载特定插画ID的图片

**支持参数**:
- **illustID**: 插画ID

**功能特点**:
- 获取高清原图
- 支持多种图片格式
- 自动选择最佳质量
- 获取作品元数据
- 支持多图作品下载
- **Web界面集成**: 通过Web界面进行可视化操作

### 4. 图像下载 ✅

**功能描述**: 下载图像文件到本地

**支持参数**:
- **imageURL**: 图像URL
- **savePath**: 保存路径
- **taskID**: 任务ID（用于进度跟踪）

**功能特点**:
- 支持多种图片格式（JPG、PNG、GIF、WebP）
- 自动创建目录结构

### 5. 文件管理系统 ✅

**功能描述**: 管理爬取的文件和任务目录

**支持功能**:
- **批量删除**: 支持批量删除文件和文件夹 ✅
- **优先级删除**: 先删除文件，后删除文件夹 ✅
- **任务文件夹命名**: 时间戳+类型+哈希格式（`YYYY-MM-DD_HH-MM_taskType_hash`）✅
- **文件树浏览**: 可视化浏览任务文件和目录 ✅
- **按时间排序**: 文件树按修改时间降序排列（新文件在前）✅
- **根目录保护**: 禁止删除images根目录 ✅
- **路径解析**: 正确的路径解析（处理绝对路径）✅

**任务文件夹命名规则**:
```
旧格式: task_{hash} (兼容)
新格式: YYYY-MM-DD_HH-MM_{taskType}_{hash}
示例: 2025-10-28_21-16_crawl_0a64cf20

优点:
- 包含时间戳，便于识别
- 包含任务类型，便于分类
- 避免Windows文件名限制（[] 和 :）
```

**删除模式**:
1. 启用删除模式（复选框）
2. 选择文件和文件夹
3. 显示已选择数量
4. 确认删除
5. 优先删除文件，再删除文件夹
- 断点续传支持
- 文件完整性验证
- 实时下载进度显示
- 智能重试机制（最多5次重试）
- 指数退避延迟策略
- 下载统计和失败文件统计
- **文件存在检查**: 自动跳过已存在的文件，避免重复下载
- **动态大小下载**: 自动处理无Content-Length头的响应，支持分块传输
- **智能缓存系统**: 按日期缓存爬取结果，避免重复API请求
- **Web界面集成**: 通过Web界面进行可视化操作和进度监控

## ⚙️ 配置参数

### 基础配置
- **cookie**: Pixiv登录Cookie信息
- **user_agent**: 浏览器标识字符串
- **accept**: 接受的内容类型
- **accept_language**: 接受的语言类型
- **referer**: 请求来源页面

### 爬取配置
- **delay**: 请求延迟时间（秒）
- **retry_count**: 重试次数
- **timeout**: 请求超时时间
- **concurrent_limit**: 并发限制
- **max_delay**: 最大延迟时间

### 下载配置
- **save_dir**: 下载保存目录
- **filename_template**: 文件名模板（支持 {id}, {title}, {page}, {ext} 占位符）
- **overwrite**: 是否覆盖已存在文件
- **create_subdirs**: 是否创建子目录
- **max_file_size**: 最大文件大小限制
- **progress_display**: 是否显示下载进度条
- **auto_retry**: 是否启用自动重试
- **retry_count**: 最大重试次数
- **timeout**: 下载超时时间（秒）

### 代理配置
- **enabled**: 是否启用代理
- **url**: 代理服务器地址

## 🔄 工作流程

### 1. 标签搜索流程
- 接收标签搜索参数
- 构建Pixiv搜索API请求
- 发送HTTP请求获取搜索结果
- 解析JSON响应数据
- 提取插画基本信息
- 获取详细图片URL
- 返回结构化的插画数据

### 2. 用户作品流程
- 接收用户ID参数
- 构建用户作品API请求
- 发送HTTP请求获取用户作品列表
- 解析用户作品数据
- 遍历作品列表获取详细信息
- 提取每个作品的图片URL
- 返回用户作品数据集合

### 3. 单图下载流程
- 接收插画ID参数
- 构建插画详情API请求
- 获取插画页面信息
- 解析图片URL列表
- 选择最佳质量图片
- 下载图片文件到本地
- 验证文件完整性

### 4. 批量下载流程
- 接收图片URL列表
- 创建并发下载任务
- 实时显示下载进度条
- 智能重试失败下载
- 统计下载结果和失败文件
- 生成详细的下载报告
- 按爬取类型自动创建子目录

## 🛡️ 安全机制

### 1. 请求限流
- 自动延迟控制机制
- 请求频率限制保护
- 智能重试机制
- 并发数量控制

### 2. 反爬虫对策
- 随机User-Agent轮换
- 完整的请求头伪装
- Cookie会话管理
- HTTP代理支持

### 3. 错误处理
- 网络错误自动重试（指数退避策略）
- 解析错误智能跳过
- 超时处理机制
- 异常恢复策略
- 下载失败统计和报告
- Gzip压缩响应自动处理

## 📝 文件命名系统

### 多图片下载功能

**功能描述**: 自动下载同一插画的所有页面图片，支持多页作品完整下载

**下载机制**:
- 自动获取插画的所有页面图片URL
- 为每个页面创建独立的 `PixivImage` 对象
- 按页面顺序自动编号下载

**文件命名规则**:
- 格式：`artworks_{插画ID}_p{页码}.jpg`
- 示例：`artworks_133380381_p01.jpg`, `artworks_133380381_p02.jpg`
- 页码使用两位数字格式（p01, p02, p03...）

**日志输出**:
- 显示每张图片的添加进度
- 显示插画的详细信息
- 显示图片保存状态和文件路径

**性能优势**:
- 完整下载多页作品，不遗漏任何页面
- 智能编号系统，便于文件管理和查找
- 支持大规模批量下载多页作品
- **累计计数显示**: 实时显示累计添加的图片总数，便于监控进度

### 动态大小下载功能

**功能描述**: 自动处理服务器不提供Content-Length头的情况，支持分块传输和动态内容下载

**处理机制**:
- 检测服务器是否提供Content-Length头
- 有Content-Length时使用进度条显示下载进度
- 无Content-Length时使用动态下载模式
- 自动记录实际下载的文件大小

**适用场景**:
- 分块传输编码 (Chunked Transfer Encoding)
- 动态生成的内容
- 代理服务器不转发Content-Length头
- 流式传输的图片内容

**日志输出**:
- 显示下载模式选择（动态或固定大小）
- 显示下载进度和文件大小
- 显示下载成功状态和保存路径

**性能优势**:
- 兼容更多服务器配置
- 避免因Content-Length缺失导致的下载失败
- 支持各种HTTP传输模式
- 提高下载成功率

### 智能缓存系统

**功能描述**: 按日期缓存爬取结果，避免重复API请求，大幅提升爬取效率

**缓存机制**:
- 按日期自动生成缓存文件 (格式: `{type}_{user_id}_{date}.json` 或 `{type}_{date}_{query}.json`)
- 缓存文件存储在 `backend/data/cache/` 目录下
- 自动检查缓存文件是否为当天生成
- 支持用户爬取和标签爬取的缓存

**缓存文件结构**:
- 包含日期、类型、查询参数等元数据
- 存储用户ID、限制数量等配置信息
- 包含图片列表和创建更新时间
- 使用JSON格式便于解析和更新

**使用场景**:
- 同一天内多次爬取相同用户或标签
- 网络不稳定时的断点续爬
- 批量处理多个用户或标签
- 开发调试时的快速测试

**日志输出**:
- 显示缓存文件查找结果
- 显示缓存数据使用状态
- 显示缓存文件保存状态

**性能优势**:
- 避免重复API请求，节省网络带宽
- 大幅提升重复爬取的速度
- 减少对Pixiv服务器的压力
- 支持离线模式下的数据复用

### 文件存在检查功能

**功能描述**: 在下载前自动检查文件是否已存在，避免重复下载，提高效率

**检查机制**:
- 使用 `os.Stat()` 检查目标文件是否存在
- 如果文件已存在，直接跳过下载并记录日志
- 如果文件不存在或检查出错，继续正常下载流程
- 保持原有的重试机制和错误处理

**日志输出**:
- 显示文件存在检查结果
- 显示跳过下载的文件路径

**性能优势**:
- 避免不必要的网络请求
- 减少磁盘I/O操作
- 大幅提高批量下载效率
- 支持断点续传场景

### 文件名模板功能

**功能描述**: 支持灵活的文件命名模板，可以根据插画信息自动生成有意义的文件名

**支持占位符**:
- **{id}**: 插画ID
- **{title}**: 插画标题
- **{page}**: 页码（多图作品）
- **{ext}**: 文件扩展名

**模板示例**:
- `"{id}_{title}"`: 生成格式如 `103593028_作品标题.jpg`
- `"{id}_p{page}_{title}"`: 生成格式如 `103593028_p0_作品标题.jpg`
- `"artworks_{id}_{title}"`: 生成格式如 `artworks_103593028_作品标题.jpg`

**自动目录结构**:
- 按标签爬取: `data/images/tag_{标签名}/`
- 按用户爬取: `data/images/user_{用户ID}/`
- 按插画爬取: `data/images/illust_{插画ID}/`

**文件命名规则**:
- 自动清理文件名中的非法字符
- 限制文件名长度避免系统限制
- 处理重复文件名冲突
- 保持文件扩展名正确性

## 🌐 API接口

### HTTP API端点

**爬虫任务管理**:
- `POST /api/crawl/create` - 创建爬虫任务
- `POST /api/crawl/results` - 获取爬虫结果
- `POST /api/generated/images` - 获取生成的图片

**文件管理**:
- `POST /api/filetree` - 获取文件树（支持按时间排序）
- `POST /api/files/delete` - 批量删除文件和文件夹
- `GET /api/images/{path}` - 获取图片文件

**任务管理**:
- `POST /api/task/start` - 启动任务
- `POST /api/task/stop` - 停止任务
- `POST /api/task/cleanup` - 清理任务
- `POST /api/status` - 获取任务状态
- `POST /api/cancel` - 取消任务
- `POST /api/delete` - 删除任务
- `POST /api/tasks` - 获取任务列表

**图片服务**:
- `GET /api/tasks/{taskId}/images/{imageIndex}` - 获取任务图片
- `GET /api/images/{path}` - 图片文件服务

**系统信息**:
- `POST /api/system/info` - 获取系统信息
- `POST /api/filetree` - 获取文件树

### WebSocket实时通信

**消息类型**:
- `task_update` - 任务状态更新
- `log_message` - 日志消息
- `global_log` - 全局日志消息

**前端显示增强**:
- 任务类型中文显示（爬取任务、标签任务、生成任务）✅
- 批量删除UI（复选框选择、已选数量显示）✅
- 文件树排序（按修改时间降序）✅
- 任务状态区分（已完成/部分完成/失败）✅

**任务更新数据结构**:
```json
{
  "type": "task_update",
  "task_id": "task_id",
  "data": {
    "task_id": "task_id",
    "status": "running|completed|failed|cancelled",
    "progress": 50,
    "images_found": 10,
    "images_downloaded": 8,
    "images_generated": 10,
    "images_success": 8,
    "result": {...},
    "time": "2025-01-01 12:00:00"
  }
}
```

## 📊 数据模型

### PixivImage数据结构
包含以下字段信息：
- **ID**: 插画唯一标识符
- **Title**: 插画标题
- **URL**: 图片访问链接
- **Author**: 作者名称
- **AuthorID**: 作者ID
- **Tags**: 标签列表
- **IsR18**: R18内容标识
- **Bookmarks**: 收藏数量
- **Views**: 浏览数量
- **CreatedAt**: 创建时间
- **Width**: 图片宽度
- **Height**: 图片高度

### CrawlCache缓存结构
- **Date**: 缓存日期 (YYYY-MM-DD)
- **Type**: 爬取类型 (tag/user/illust)
- **Query**: 查询参数
- **UserID**: 用户ID (仅用户爬取时使用)
- **Limit**: 限制数量
- **Images**: 图片数据列表
- **CreatedAt**: 创建时间
- **UpdatedAt**: 更新时间

## 🚨 错误处理

### 常见错误类型
- **爬虫初始化失败**: 配置错误或环境问题
- **请求失败**: 网络连接或API访问问题
- **下载失败**: 文件下载或保存问题
- **网络错误**: 连接超时或网络异常
- **参数无效**: 输入参数格式错误

### 错误处理策略
1. **自动重试机制**: 网络错误自动重试
2. **降级处理策略**: 使用备用方案
3. **错误跳过机制**: 跳过有问题的项目
4. **详细日志记录**: 记录错误详情便于调试

## 📈 性能优化

### 1. 并发控制
- 限制并发请求数量
- 使用HTTP连接池
- 异步任务处理

### 2. 缓存机制
- 请求结果缓存
- 图片URL缓存
- 用户信息缓存

### 3. 内存优化
- 流式处理大文件
- 及时释放资源
- 垃圾回收优化

### 4. 下载优化
- 实时进度显示（每5%更新）
- 智能重试机制（指数退避）
- Gzip压缩响应自动处理
- 文件完整性验证
- 连接复用和Keep-Alive
- 优化的HTTP传输配置
- 文件存在检查机制（避免重复下载）

### 5. 网络优化
- 完整的浏览器请求头模拟
- 智能超时处理（120秒）
- 代理支持和高可用性
- 反爬虫对策优化

## 🔒 合规使用

### 1. 遵守规则
- 遵守Pixiv使用条款
- 尊重版权规定
- 合理使用频率

### 2. 数据保护
- 保护用户隐私信息
- 合理使用爬取数据
- 遵守相关法律法规
- 不存储敏感信息
- 保护用户隐私
- 数据安全传输

### 3. 使用建议
- 设置合理的延迟
- 避免频繁请求
- 尊重服务器负载

## 🧪 测试

### 1. 单元测试
- 运行爬虫模块的单元测试
- 验证各个组件的独立功能

### 2. 集成测试
- 运行集成测试验证模块间协作
- 测试完整的爬取流程

### 3. 压力测试
- 运行性能基准测试
- 评估系统在高负载下的表现

### 4. 下载功能测试
- 测试进度条和重试机制
- 测试不同文件名模板
- 测试代理功能
- 测试文件存在检查功能
- 测试多图片下载功能

### 5. 性能基准测试
- 测试下载速度和内存使用
- 测试并发性能
- 进行性能分析和优化

## 📚 使用说明

### 1. 基础爬取
- 创建爬虫实例
- 按标签爬取插画数据
- 下载图片到指定目录

### 1.1 使用自定义文件名模板
- 设置自定义文件名模板
- 按用户爬取作品
- 自动按照模板生成文件名

### 2. 批量处理与下载统计
- 批量爬取多个标签
- 统计下载成功和失败的数量
- 按标签组织下载文件

### 3. 错误处理与重试机制
- 处理不同类型的错误（网络、请求等）
- 自动重试机制和指数退避策略
- 文件存在检查和跳过下载

### 4. 配置优化
- 配置爬虫参数（超时时间、重试次数等）
- 设置代理服务器
- 自定义文件名模板和下载选项

## 🎯 任务管理集成

爬虫模块已集成到统一的任务管理系统中，实现智能队列调度和并发控制。

### 任务执行流程

```
1. CrawlerHandler 接收请求
   ↓
2. 创建爬虫任务（taskService.CreateTask("crawl", config)）
   ↓
3. TaskService 检查队列
   - 如果同类型有运行中任务 → 加入等待队列
   - 如果没有 → 立即启动
   ↓
4. executeCrawlTask 执行爬取
   - 创建爬虫实例
   - 执行爬取（tag/user/illust）
   - 保存结果
   ↓
5. 任务完成 → 自动启动下一个等待中的任务
```

### 并发控制

- **同类型串行**: 多个 crawl 任务依次执行
- **不同类型并发**: generate、crawl、tag 任务可以同时运行
- **智能队列**: 按类型分组的等待队列，互不干扰

### API 接口

```typescript
// 创建爬虫任务
POST /api/crawl/create
{
  "crawl_type": "tag",
  "query": "tag1,tag2",
  "limit": 10,
  ...
}

// 获取爬虫任务列表
POST /api/tasks
{
  "pagination": {"page": 1, "page_size": 20},
  "type": "crawl"  // 筛选爬虫任务
}

// 停止爬虫任务
POST /api/task/stop
{
  "task_id": "..."
}
```

详见[任务管理器文档](./task-manager.md)了解更多细节。

## 📚 相关文档

- [任务管理器文档](./task-manager.md) - 统一的任务调度系统
- [AI模块文档](./ai-module.md) - AI生成任务
- [标签模块文档](./tagger-module.md) - 图像标签生成
- [配置模块文档](./config-module.md) - 配置文件管理
