# PixivTailor 部署指南

## 概述

PixivTailor 采用前后端分离架构，使用 HTTP + WebSocket 进行通信，支持本地部署和开发环境快速启动。

## 架构组件 (当前实现)

- **前端**: React + TypeScript + Ant Design + Vite
- **后端**: Go + HTTP + WebSocket + SQLite
- **文件存储**: 本地文件系统
- **实时通信**: WebSocket
- **配置管理**: JSON配置文件

## 快速开始

### 1. 环境要求 ✅

- **Go 1.21+** - 后端开发环境
- **Node.js 18+** - 前端开发环境
- **Windows 10/11** - 操作系统支持
- **现代浏览器** - Chrome/Firefox/Edge
- **至少 2GB 内存** - 推荐 4GB+
- **至少 5GB 磁盘空间** - 用于存储图片和缓存

### 2. 项目准备 ✅

- 克隆项目到本地
- 进入项目目录
- 检查项目结构，确认包含backend、frontend、docs、scripts等目录

### 3. 一键启动 ✅

- 使用启动脚本快速启动所有服务（推荐方式）
- 支持开发环境和生产环境启动
- 自动启动后端服务和前端应用

### 4. 服务访问 ✅

- **Web界面**: 通过浏览器访问管理界面
- **后端API**: 提供REST API接口服务
- **WebSocket**: 提供实时通信服务
- **健康检查**: 提供系统健康状态检查

## 详细配置

### 环境变量配置

#### 后端服务
- **GRPC_PORT**: gRPC服务端口
- **DB_PATH**: 数据库文件路径 (默认: data/database/pixiv_tailor.db)
- **LOG_LEVEL**: 日志级别
- **CONFIG_PATH**: 配置文件路径

#### 前端服务
- **REACT_APP_API_URL**: API服务地址
- **REACT_APP_GRPC_PORT**: gRPC服务端口
- **REACT_APP_VERSION**: 应用版本

#### 数据库服务
- **REDIS_URL**: Redis连接地址
- **REDIS_PASSWORD**: Redis密码
- **REDIS_DB**: Redis数据库编号

### 配置文件

#### 主配置文件
- **系统配置**: 基础系统设置
- **模块配置**: 各功能模块配置
- **用户配置**: 用户个性化设置

#### Docker配置
- **容器配置**: 容器运行参数
- **网络配置**: 容器网络设置
- **存储配置**: 数据持久化设置

## 部署方式

### 1. Docker Compose部署

**优势**:
- 一键启动所有服务
- 自动配置服务依赖
- 支持服务扩展
- 便于开发调试

**适用场景**:
- 开发环境部署
- 测试环境部署
- 小规模生产环境

### 2. Kubernetes部署

**优势**:
- 高可用性保障
- 自动扩缩容
- 服务发现和负载均衡
- 滚动更新

**适用场景**:
- 大规模生产环境
- 高可用性要求
- 微服务架构

### 3. 传统部署

**优势**:
- 直接控制服务
- 性能优化空间大
- 便于调试和维护

**适用场景**:
- 资源受限环境
- 特殊安全要求
- 定制化需求

## 服务配置

### 后端服务配置

**gRPC服务**:
- 端口配置
- 超时设置
- 连接池配置
- 安全认证

**数据库配置**:
- 连接参数
- 连接池设置
- 事务配置
- 备份策略

**日志配置**:
- 日志级别
- 输出格式
- 文件轮转
- 远程日志

### 前端服务配置

**构建配置**:
- 构建优化
- 资源压缩
- 环境变量
- 版本管理

**运行时配置**:
- API地址配置
- 路由配置
- 缓存策略
- 错误处理

### 代理服务配置

**Nginx配置**:
- 反向代理
- 负载均衡
- SSL证书
- 缓存配置

**安全配置**:
- 访问控制
- 请求限制
- 安全头设置
- 日志记录

## 监控配置

### 系统监控

**Prometheus配置**:
- 指标收集
- 告警规则
- 数据保留
- 查询配置

**Grafana配置**:
- 仪表板配置
- 数据源配置
- 告警通知
- 用户管理

### 应用监控

**性能监控**:
- 响应时间
- 吞吐量
- 错误率
- 资源使用

**业务监控**:
- 用户行为
- 功能使用
- 数据统计
- 异常检测

## 安全配置

### 网络安全

**防火墙配置**:
- 端口访问控制
- IP白名单
- DDoS防护
- 入侵检测

**SSL/TLS配置**:
- 证书管理
- 加密算法
- 协议版本
- 证书更新

### 应用安全

**认证授权**:
- 用户认证
- 权限控制
- 会话管理
- 安全令牌

**数据安全**:
- 数据加密
- 敏感信息保护
- 数据备份
- 访问审计

## 备份与恢复

### 数据备份

**数据库备份**:
- 定期备份
- 增量备份
- 备份验证
- 异地存储

**配置备份**:
- 配置文件备份
- 环境变量备份
- 证书备份
- 备份验证

### 灾难恢复

**恢复流程**:
- 服务恢复
- 数据恢复
- 配置恢复
- 验证测试

**RTO/RPO目标**:
- 恢复时间目标
- 数据丢失容忍度
- 服务可用性
- 业务连续性

## 维护与升级

### 日常维护

**系统维护**:
- 日志清理
- 临时文件清理
- 数据库优化
- 性能监控

**安全维护**:
- 安全更新
- 漏洞扫描
- 访问审计
- 证书更新

### 版本升级

**升级流程**:
- 备份数据
- 停止服务
- 更新代码
- 配置迁移
- 启动服务
- 功能验证

**回滚策略**:
- 版本回滚
- 数据回滚
- 配置回滚
- 服务恢复

## Stable Diffusion WebUI 集成

### WebUI 安装与配置

**WebUI 安装**:
1. 安装 Python 3.10+
2. 安装 Stable Diffusion WebUI
3. 安装 WD14 Tagger 扩展（用于图像标签生成）
4. 下载所需模型文件

**WebUI 配置**:
- **端口**: 默认 7860
- **API 启用**: 使用 `--api` 启动参数
- **标签器设备**: 使用 `--tagger-device cpu` 或 `--tagger-device cuda`（推荐 CPU）
- **模型路径**: 确保模型文件正确放置

**启动 WebUI**:
```bash
# 使用示例
python launch.py --api --tagger-device cpu

# 或使用提供的脚本
scripts/start-webui-api.bat
```

### WebUI 状态监控 ✅

**功能描述**: 实时监控 Stable Diffusion WebUI 的运行状态

**支持功能**:
- **状态检测**: 定期检测 WebUI 是否运行 ✅
- **连接检查**: 验证 API 端点可访问性 ✅
- **前端显示**: 在AI生成器页面显示WebUI状态 ✅
- **自动重试**: 连接失败时自动重试 ✅
- **日志记录**: 记录WebUI连接日志 ✅

**监控机制**:
```typescript
// 前端每5秒检查一次WebUI状态
useEffect(() => {
  const interval = setInterval(() => {
    checkWebUIStatus();
  }, 5000);
  return () => clearInterval(interval);
}, []);
```

**状态显示**:
- **运行中**: 绿色指示器，显示可用
- **已停止**: 红色指示器，显示不可用
- **错误**: 黄色指示器，显示错误信息

**API 端点**:
- `GET /api/webui/status` - 获取WebUI状态
- `POST /api/webui/start` - 启动WebUI（如果支持）
- `POST /api/webui/stop` - 停止WebUI（如果支持）

### 常见 WebUI 问题

**WD14 Tagger CUDA 错误**:
- 问题: 提示需要 cuDNN 9.x 和 CUDA 12.x
- 解决方案: 使用 CPU 模式运行 `--tagger-device cpu`
- 或安装正确的 CUDA/cuDNN 版本

**API 不可访问**:
- 检查 WebUI 是否使用 `--api` 参数启动
- 检查防火墙设置
- 验证端口是否被占用

**标签生成失败**:
- 检查 WD14 Tagger 扩展是否安装
- 检查模型文件是否存在
- 查看 WebUI 日志获取详细错误

## 故障排除

### 常见问题

**服务启动失败**:
- 检查端口占用
- 检查配置文件
- 检查依赖服务
- 查看错误日志

**性能问题**:
- 监控资源使用
- 分析响应时间
- 检查数据库性能
- 优化配置参数

**网络问题**:
- 检查网络连接
- 验证防火墙设置
- 检查DNS解析
- 测试端口连通性

### 日志分析

**日志类型**:
- 应用日志
- 系统日志
- 访问日志
- 错误日志

**分析方法**:
- 关键字搜索
- 时间范围过滤
- 错误模式识别
- 性能趋势分析

## 最佳实践

### 部署最佳实践

**环境隔离**:
- 开发环境
- 测试环境
- 预生产环境
- 生产环境

**配置管理**:
- 环境变量管理
- 配置文件版本控制
- 敏感信息保护
- 配置验证

### 运维最佳实践

**监控告警**:
- 关键指标监控
- 告警阈值设置
- 告警通知配置
- 告警处理流程

**容量规划**:
- 资源需求评估
- 性能基准测试
- 扩容策略制定
- 成本优化

### 安全最佳实践

**安全策略**:
- 最小权限原则
- 深度防御
- 定期安全审计
- 安全培训

**数据保护**:
- 数据分类管理
- 访问控制策略
- 数据备份策略
- 合规性要求